doctype html
html
  head
    title Manage IRealBook Instance
    link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css")
  body
    main.container 
      h1 Manage IRealBook Instance
      h6
        strong= tuneCount
        span  Tunes / 
        strong= tuneVersionCount
        span  Versions 

      article
        h3 Full Text Search
        h6 
          strong= ftsSize
          span  Tunes included in FTS Index
        progress(max=tuneCount value=ftsSize)
        form(method="post" action="?buildFTS")
          button(data-tooltip="Prepare full-text-search engine.") Re-build FTS Index

      article
        h3 Add Source
        form(method="post" enctype="multipart/form-data" action="?addSource")
          div.grid 
            label PDF File
              input(type="file" name="book" accept="application/pdf", required)
            label Index Table
              input(type="file" name="index" accept="text/csv", required)
          div.grid
            label Name
              input(name="name" placeholder="The Real Book - Volume 1", required)
            label Abbreviation (Short Name)
              input(name="shortName" placeholder="RB1", required)
          div.grid
            label Publisher
              input(name="publisher" placeholder="Hal Leonard")
            label Key
              select(name="key", required) 
                option C
                option Bb
                option Eb
                option Bass
          if error
            small(style={color: "var(--pico-del-color)"})= error
          button(type="submit") Upload

      article
        h3 Actions 
        div(style={display: "flex", gap: "10px"})
          form(method="post" action="?indexTunes")
            button(data-tooltip="Extract tunes (and metadata) from all sources." data-placement="right") Re-index all Sources 
          form(method="post" action="?explodePDFs")
            button(data-tooltip="Extract individual PDFs for all tunes and their versions.") Re-explode all Sources

      if sources
        article
          h3= "Available Sources (" + sources.length + ")"

          table 
            thead 
              tr 
                th Name
                th Abbr.
                th No. Tunes
                th Indexed At
                th Exploded At
                th Actions
            tbody 
              each source in sources
                tr 
                  td
                    div(style={display: "flex"})
                      strong= source.name
                      if !sourcesValidity[source.id]
                        div(data-tooltip="Missing PDF or index file", style={color: "var(--pico-del-color)", width: "15px", "margin-left": "5px"})
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 512a256 256 0 1 0 0-512 256 256 0 1 0 0 512zM167 167c9.4-9.4 24.6-9.4 33.9 0l55 55 55-55c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-55 55 55 55c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-55-55-55 55c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l55-55-55-55c-9.4-9.4-9.4-24.6 0-33.9z"/></svg>

                  td= source.shortName
                  td 
                    if source.lastIndexedAt
                      span= versionsPerSource[source.id]
                    else
                      span ?
                  td
                    if source.lastIndexedAt
                      em.ts(data-ts=source.lastIndexedAt)
                    else 
                      del Never
                  td
                    if source.lastExplodedAt
                      em.ts(data-ts=source.lastExplodedAt)
                    else 
                      del Never
                  td
                    div(style={display: "flex", gap: "10px"})
                      form(method="post" enctype="multipart/form-data" action="?indexTunes")
                        input(type="hidden" name="id", value=source.id)
                        button.outline(data-tooltip="Extract tunes (and metadata) from this sources.") Index
                      form(method="post" enctype="multipart/form-data" action="?explodePDFs")
                        input(type="hidden" name="id", value=source.id)
                        button.outline(data-tooltip="Extract individual PDFs for all tunes in this source." disabled=!source.lastIndexedAt) Explode
                      form(method="post" enctype="multipart/form-data" action="?deleteSource")
                        input(type="hidden" name="id", value=source.id)
                        button.outline.contrast Delete
          form(method="post" enctype="multipart/form-data" action="?deleteSources" style={"text-align": "right"})
            button.contrast Delete All

    script.
      const rtf = new Intl.RelativeTimeFormat("en", { style: "short", numeric: "auto" });
      const tf = new Intl.DateTimeFormat("en", {
        dateStyle: "long",
        timeStyle: "short"
      })
      document.querySelectorAll(".ts").forEach(el => {
        const ts = new Date(el.dataset.ts);
        const diff = (ts - Date.now()) / 1000 / 60 / 60 / 24;
        el.textContent = rtf.format(Math.round(diff), "day");
        el.dataset.tooltip = tf.format(ts)
      });
